# 主备堆叠三层网络总体理论

## 一、学习目标与适用人群

- **适用对象**：零基础或只做过简单二层/三层实验，希望掌握“主备堆叠 + 核心/汇聚/接入”典型网络架构的新手。
- **学习目标**：
  - **理解**：二层、三层、VLAN、路由这几个核心概念。
  - **掌握**：什么是堆叠、主备角色、堆叠能解决什么问题。
  - **能画**：一张典型的“核心堆叠 + 汇聚 + 接入”网络拓扑。
  - **能做**：在模拟器或真实设备上按步骤搭建一个简化版主备堆叠网络。

---

## 二、从“数据怎么走”开始：二层 vs 三层

### 1. 三个关键要素

- **MAC 地址（物理地址）**：同一个二层网络（一个广播域）内用来标识设备。
- **IP 地址（逻辑地址）**：跨网络通信时，用来标识“网络 + 主机”。
- **网关（Gateway）**：某个网段设备访问其它网段时，流量必须经过的三层设备接口。

### 2. 二层转发（交换）

- 设备：二层交换机。
- 依据：**MAC 地址表 + VLAN 信息**。
- 特点：
  - 不看 IP，只看 MAC。
  - 同一 VLAN 内的广播会被所有端口收到（同一广播域）。

### 3. 三层转发（路由）

- 设备：路由器或三层交换机。
- 依据：**路由表（RIB/FIB）**。
- 特点：
  - 按目标 IP 查找路由表，决定下一跳和出接口。
  - 实现不同网段/不同 VLAN 之间的通信。

---

## 三、VLAN 与接口模式：搭好二层“地基”

### 1. VLAN 的作用

- 划分逻辑子网：把一个物理交换网络拆出多个逻辑二层广播域。
- 典型用途：
  - 按部门划分：办公 VLAN、研发 VLAN、访客 VLAN、监控 VLAN。
  - 限制广播范围，提高安全性和性能。

### 2. 三种接口模式（以常见厂商为例）

- **Access 口**：
  - 用来连接终端（PC、打印机、AP）。
  - 只属于一个 VLAN，进出都是 **不带标签（Untagged）**。
- **Trunk 口**：
  - 用来连接其他交换机、三层设备。
  - 可以承载多个 VLAN，报文在链路上传输时 **带 VLAN 标签（Tagged）**。
- **Hybrid 口**（不同厂商叫法略有区别，可视为进阶内容）：
  - 能同时承载多个 VLAN，可灵活指定哪些 VLAN 带标签、哪些不带。
  - 常用于“同网段又要做部分隔离”的特殊场景。

### 3. PVID 的关键概念

- PVID（Port VLAN ID）：端口默认 VLAN ID。
- 未带标签的报文进端口时，会被打上 PVID 对应的 VLAN ID。
- 一般使用：
  - Access 口：PVID = 该口所属 VLAN。
  - Trunk 口：PVID = 本端默认 VLAN（如管理 VLAN）。

---

## 四、IP 路由基础与缺省路由

### 1. 路由表的组成

每一条路由条目通常包括：

- 目的网段 + 掩码（例如 192.168.10.0/24）
- 下一跳地址（例如 192.168.1.1）或者出接口（例如 GE0/0/1）
- 路由来源（直连、静态、动态协议等）与优先级

### 2. 路由选择的两个原则

- **最长前缀匹配**：掩码越长，匹配越具体，优先级越高。
- **路由优先级**：同一前缀时，不同路由来源有不同优先级（通常：直连 > 动态路由 > 静态 > 缺省）。

### 3. 缺省路由

- 形式：`0.0.0.0/0`。
- 含义：当路由表中找不到更精确匹配时，所有“不认识”的流量都走这条路。
- 常见场景：
  - 内网网关把未知流量全部指向出口路由器 / 防火墙。

---

## 五、堆叠（Stack）与主备体系

### 1. 堆叠的定义

**堆叠：多台交换机通过专用堆叠端口与协议连接，虚拟为一台逻辑交换机进行统一管理、转发和冗余的技术。**

### 2. 堆叠解决的核心问题

- **高可用**：主设备故障时由备设备快速接管，提升可靠性。
- **扩展性**：通过增加成员交换机，横向扩展端口数量和转发性能。
- **简化管理**：对下游网络来说，堆叠后的多台设备看起来就是“一个设备、一个管理 IP、一个配置”。

### 3. 堆叠中的角色

- **主交换机（Master）**：
  - 整个堆叠系统的“主控”，负责控制平面、协议处理、路由计算等。
  - 堆叠中只会有一台 Master。
- **备交换机（Standby）**：
  - Master 的热备，一般保持状态同步，一旦 Master 故障，快速顶上。
  - 堆叠中通常只有一台 Standby。
- **从交换机（Slave）**：
  - 主要负责业务转发，相当于一块块“扩展板”。
  - 可以有多台，用来增加端口密度和整体带宽。

**直观比喻**：一堆交换机堆在一起像“一台大交换机机框”，里面有主控板（Master）、备用主控板（Standby）、多块业务板（Slaves）。

### 4. 堆叠接线与常见拓扑

- **堆叠链型**：设备 A ↔ 设备 B ↔ 设备 C，一头连一头。
  - 实现简单，但若中间链路或设备故障，可能影响较大范围。
- **堆叠环型**：设备 A ↔ 设备 B ↔ 设备 C ↔ 再回到 A。
  - 即便一处堆叠链路中断，整体仍保持连通，更可靠。

关键原则是：**保证堆叠成员之间至少有一条完整的控制通路可达**。

### 5. 双主问题与 DAD（Dual-Active Detection）

- **脑裂/双主问题**：
  - 主备之间的堆叠心跳链路全部中断，但两台设备对外的业务口还在。
  - 两台设备都认为对方死了，于是都变成 Master，同时对外提供相同网段的网关或服务，导致网络混乱。
- **DAD 的作用**：
  - 通过额外的检测链路或第三方设备，发现“两个主”的情况。
  - 检测到双主后，自动关闭其中一侧的业务端口，避免冲突。
- **实践建议**：
  - 有堆叠就要设计 DAD（例如接到一台独立交换机/路由器上做探测）。
  - 不要只依赖堆叠线自身的心跳。

---

## 六、典型三层架构：核心堆叠 + 汇聚 + 接入

### 1. 三层角色介绍

- **核心层（Core）**：
  - 建议采用两台高性能交换机堆叠成一个核心。
  - 职责：跨区域三层路由、与出口/防火墙连接、关键策略控制。
- **汇聚层（Aggregation）**：
  - 承接接入层上来流量，向上连接核心堆叠。
  - 职责：VLAN 汇聚、策略下沉、部分路由/ACL。
- **接入层（Access）**：
  - 直接连接终端（PC、AP、摄像头等）。
  - 职责：终端接入、安全控制（802.1X/MAC 认证）、基础 QoS 等。

### 2. 一个典型的主备堆叠三层拓扑（文字描述）

假设：

- 两台核心交换机 Core1、Core2 堆叠为 Core-Stack。
- 两台汇聚交换机 Agg1、Agg2。
- 若干接入交换机 Acc1、Acc2……
- 一个出口路由器或防火墙 FW。
- 若干业务 VLAN：
  - VLAN 10：办公网
  - VLAN 20：服务器网
  - VLAN 30：访客网
  - VLAN 99：管理 VLAN

数据流大致路径：

- 终端 → 接入交换机（Access 口）→ 上联到汇聚（Trunk/Eth-Trunk）→ 上联到核心堆叠（Trunk/Eth-Trunk）→ 由核心上的网关 VLAN 三层接口进行转发 → 目标网段或出口。

### 3. VLAN 与网关规划示例

- **VLAN 规划**：
  - 接入层：
    - 终端端口：Access 模式，分别划进对应业务 VLAN（10、20、30）。
    - 上联汇聚口：Trunk 模式，放行业务 VLAN + 管理 VLAN（如 99）。
  - 汇聚层：
    - 下联接入口：Trunk 模式，放行对应 VLAN。
    - 上联核心口：链路聚合（多条物理口捆绑为一条逻辑口）+ Trunk 模式。
- **网关位置**：
  - 所有业务 VLAN 的默认网关统一放在核心堆叠上：
    - VLAN 10：办公网关
    - VLAN 20：服务器网关
    - VLAN 30：访客网关
    - VLAN 99：管理网关
- **出口路由**：
  - 核心堆叠配置默认路由指向防火墙或出口路由器。
  - 出口设备再指向运营商或上级网络。

---

## 七、企业网络故障排查脉络：从现象到根因

### 1. 先问清楚“哪里、什么时候、有什么现象”

- **确认故障现象**：是“完全不通”（ping 不通）、“很慢”、“时好时坏”，还是“只有某个业务有问题”。
- **确认影响范围**：
  - 只有某一台/少数几台终端？
  - 某一层楼、某一栋楼，还是全网？
  - 内网之间不通，还是只是不出外网？
- **确认时间维度**：
  - 从什么时候开始出现？
  - 是突然发生，还是变慢一段时间后才完全不通？

> 这一步的目标：**用一句话描述故障，例如：“三楼办公网用户从昨晚起都无法访问外网，但内网服务器访问正常”。**

### 2. 快速区分：单点问题 vs 大范围问题

- **单点问题（更可能是终端/接入口问题）**：
  - 只有某几台机器有问题，同 VLAN 其他机器正常。
  - 先看终端 IP/掩码/网关配置是否正确，检查网线/网卡。
- **大范围问题（更可能是交换/路由/出口问题）**：
  - 同一楼层/同一 VLAN 大量主机一起出问题。
  - 优先关注：接入交换机上联、汇聚/核心、出口设备状态。

> 简化记忆：**“一台出问题看终端，很多台出问题看网络设备和链路”。**

### 3. 按“从近到远、从低层到高层”的顺序排查

以某台 PC 无法访问外网为例，可以按下面顺序：

1. **本机检查**：
   - `ipconfig` / `ifconfig` 查看 IP、掩码、网关是否在预期网段。
   - `ping 127.0.0.1`、`ping 本机 IP`，确认本机协议栈和网卡基本正常。
2. **到网关**：
   - `ping 默认网关 IP`：
     - 不通：重点看二层连通（VLAN、Access/Trunk 配置）、本机与接入交换机之间的物理链路。
     - 能通：说明二层/三层到网关这段基本没问题。
3. **到同网段/其他网段资源**：
   - `ping 同 VLAN 其他主机`：不通多半是二层/VLAN 问题。
   - `ping 内网服务器 IP`：不通要看三层网关、静态路由/动态路由配置。
4. **到出口/外网**：
   - `ping 出口设备内侧 IP`（防火墙/出口路由器）：不通看核心到出口的路由、ACL、安全策略。
   - `tracert 目标地址`：看报文在哪一跳停止，结合设备日志进一步排查。

> 原则：**先确认“到哪一跳都不通”，再集中火力分析那一层。**

### 4. 结合三层架构做“分层定位”

在“核心堆叠 + 汇聚 + 接入 + 出口”的架构下，可以把故障大致归类到：

- **接入层问题**：
  - 症状：某几个端口/某个接入交换机下的终端不通。
  - 常见原因：端口 VLAN 配错、PVID 错、端口被 shutdown、环路导致端口被保护（如 STP 保护）。
- **汇聚层问题**：
  - 症状：某一栋楼/某一片区域整体不通，但其他区域正常。
  - 常见原因：汇聚到核心的上联链路中断或 Eth-Trunk 成员异常、Trunk 放行 VLAN 不完整、路由/ACL 配置错误。
- **核心层问题**：
  - 症状：多个 VLAN/多个区域都出现跨网段通信问题。
  - 常见原因：核心三层网关配置错误、路由表异常、堆叠主备切换后配置不一致等。
- **出口层问题**：
  - 症状：内网之间通信正常，只有访问外网/上级网络有问题。
  - 常见原因：默认路由指向错误、NAT/安全策略配置错误、运营商链路故障等。

### 5. 常用故障排查命令与思路提示

- **基础连通性**：`ping`、`tracert`/`traceroute`。
- **查看地址解析**：`arp` 表。
- **查看二层转发表**：在交换机上看 MAC 地址表（如 `display mac-address`）。
- **查看 VLAN/接口状态**：
  - 接口 up/down 状态、端口速率/双工。
  - 端口 VLAN 所属、Trunk 放行 VLAN 列表。
- **查看路由与下一跳**：
  - `display ip routing-table` / `show ip route`，确认是否有到目标网段或默认路由。
  - 关注某条路由的下一跳是否可达。
- **查看日志与告警**：
  - 设备日志中是否有端口 flap（频繁 up/down）、路由邻居掉线、堆叠异常、CPU/内存过高等告警。

> 建议：**每次排完一个故障，把你的“排查路径”画成一张简单的流程图或文字步骤，慢慢沉淀成自己的“企业网络故障排查 SOP”。**

---

## 八、推荐学习路径：从零到能“画出一张网”

1. **第一步：网络基础与转发路径**
   - 目标：说清“从主机 A ping 主机 B，报文每一跳发生了什么”。
   - 内容：MAC、IP、ARP、网关、二层交换和三层路由的区别。
2. **第二步：二层 VLAN 与接口模式**
   - 目标：理解 Access/Trunk 区别，会做“同 VLAN 互通、不同 VLAN 不通”的实验。
3. **第三步：三层交换与静态路由**
   - 目标：掌握在三层交换机上为多个 VLAN 提供网关，实现跨 VLAN 通信。
4. **第四步：堆叠与主备高可用**
   - 目标：理解 Master/Standby/Slave 各自职责，明白堆叠对管理和高可用的好处。
5. **第五步：综合设计一张主备堆叠三层拓扑图**
   - 目标：独立画出“核心堆叠 + 汇聚 + 接入 + 出口”的网络结构，并能用自己的话解释关键配置位置。

做到以上几点，基本就具备了理解和设计典型主备堆叠网络的体系化能力。

