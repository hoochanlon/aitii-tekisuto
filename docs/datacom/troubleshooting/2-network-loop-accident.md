# 一次网络环路事故：当“部分不通”演变为全网瘫痪

## 故障摘要

范围：全网逐步瘫痪

核心表现：约 60 分钟内广播风暴指数级放大，二楼核心交换机（光纤汇聚点）最先过载，一楼核心及下游设备相继阻塞。
典型症状

初期：同 VLAN 内主机连通性不一致（部分可达，部分不可达），可 ping AC 网关但外网不通

中期：网络延迟剧增、丢包严重

后期：交换机全端口指示灯异常常亮/狂闪（即使终端关机），核心设备 CPU/内存/背板瞬间饱和

特征组合：局部可达 + 定时全挂 + 端口灯异常全亮 → 高度指向二层环路（Layer 2 Loop）导致的广播风暴

## 标准快速定位流程

### 确认风暴源头
在受影响最严重的核心/汇聚交换机执行：

* `display interface brief | include up` （观察 Broadcast / Input rate 异常高速增长的端口）
* `display cpu-defend statistics all` （查看广播/未知单播/组播风暴控制统计，定位入口端口）

### 分层隔离法（最小影响范围）

从核心交换机开始，逐一临时 shutdown 或物理拔除下联接入层/汇聚链路（优先疑似新接入/变更区域）

每断开一条链路后立即观察：广播计数是否停止增长、网络是否部分恢复
定位到具体接入交换机后，继续在该交换机上重复上述步骤，直至定位到具体端口/链路

现场验证：周末终端关机但端口灯仍全亮/狂闪 → 排除正常用户行为，确认环路。若 STP 已启用，检查`display stp brief` / `display stp interface`，确认是否存在非预期 Forwarding 端口或根桥选举异常。

### 处置与恢复

首选：快速定位后直接 shutdown 可疑端口或拔线，风暴立即消退

备选（紧急无监控时）：对风暴源头交换机执行 reload（重启），等待 1–3 分钟广播风暴自然衰减

事后：强制启用 STP/RSTP/MSTP（全局 + 端口），开启 Loopback Detection / BPDU Guard / Root Guard，防止复发

## 关键教训

二层环路是网络中最致命的故障之一，无 TTL 机制导致流量无限复制。生产环境中一旦出现上述症状组合，应放弃逐主机排查，优先采用从核心向下逐链路暴力隔离的策略，通常可在 5–15 分钟内恢复业务。
